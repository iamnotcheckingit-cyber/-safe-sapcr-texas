# Netlify configuration for safesapcrtx.org
# Optimized for SEO, security, and performance

[build]
  publish = "."
  functions = "netlify/functions"
  command = "echo 'Static site - no build required'"

# Enable asset optimization
[build.processing]
  skip_processing = false

[build.processing.css]
  bundle = true
  minify = true

[build.processing.js]
  bundle = true
  minify = true

[build.processing.html]
  pretty_urls = true

[build.processing.images]
  compress = true

# ============================================
# FUNCTIONS CONFIGURATION
# ============================================

[functions]
  # Node.js version for serverless functions
  node_bundler = "esbuild"

  # Rate limiting for functions (abuse prevention)
  [functions."chat"]
    rate_limit = { window_size = 60, window_limit = 10 }

  [functions."newsletter-signup"]
    rate_limit = { window_size = 60, window_limit = 5 }

  [functions."contact-legislator"]
    rate_limit = { window_size = 60, window_limit = 5 }

  [functions."send-email"]
    rate_limit = { window_size = 60, window_limit = 3 }

  [functions."membership-notify"]
    rate_limit = { window_size = 60, window_limit = 3 }

  [functions."honeypot-sink"]
    rate_limit = { window_size = 60, window_limit = 20 }

  [functions."webhook-callback"]
    rate_limit = { window_size = 60, window_limit = 30 }

  [functions."petition-signatures"]
    rate_limit = { window_size = 60, window_limit = 5 }

  [functions."outreach-stats"]
    rate_limit = { window_size = 60, window_limit = 30 }

  [functions."tor-detection"]
    rate_limit = { window_size = 60, window_limit = 100 }

# ============================================
# EDGE FUNCTIONS CONFIGURATION
# ============================================

[[edge_functions]]
  path = "/*"
  function = "tor-watcher"
  excludedPath = ["/assets/*", "/images/*", "/css/*", "/js/*", "/.netlify/*", "/fonts/*", "/*.ico", "/*.png", "/*.jpg", "/*.svg", "/*.woff*"]

[[edge_functions]]
  path = "/*"
  function = "thank-you"
  excludedPath = ["/assets/*", "/images/*", "/css/*", "/js/*", "/.netlify/*", "/fonts/*", "/*.ico", "/*.png", "/*.jpg", "/*.svg", "/*.woff*"]

# ============================================
# REDIRECTS - Clean URLs handled by _redirects file
# ============================================

[[redirects]]
  from = "/index.html"
  to = "/"
  status = 301
  force = true

# WordPress scanner traps - redirect to honeypots
[[redirects]]
  from = "/wp-admin/*"
  to = "/wp-admin/index.html"
  status = 200
  force = true

[[redirects]]
  from = "/wordpress/*"
  to = "/wordpress/wp-admin/index.html"
  status = 200
  force = true

[[redirects]]
  from = "/*wlwmanifest.xml"
  to = "/404"
  status = 410
  force = true

# XML-RPC honeypot
[[redirects]]
  from = "/xmlrpc.php"
  to = "/xmlrpc.html"
  status = 200
  force = true

# Staging honeypot
[[redirects]]
  from = "/staging"
  to = "/staging.html"
  status = 200
  force = true

[[redirects]]
  from = "/staging/*"
  to = "/staging.html"
  status = 200
  force = true

# Database dump honeypot
[[redirects]]
  from = "/dump.sql"
  to = "/dump.html"
  status = 200
  force = true

# Shell honeypot
[[redirects]]
  from = "/shell/*"
  to = "/shell/index.html"
  status = 200
  force = true

# Members honeypot
[[redirects]]
  from = "/members/*"
  to = "/members/export/index.html"
  status = 200
  force = true

[[redirects]]
  from = "/members"
  to = "/members/export/index.html"
  status = 200
  force = true

# Case files honeypot
[[redirects]]
  from = "/case-files/confidential/*"
  to = "/case-files/confidential/index.html"
  status = 200

[[redirects]]
  from = "/case-files/*"
  to = "/case-files/confidential/index.html"
  status = 200

# Finance honeypot
[[redirects]]
  from = "/finance/reports/*"
  to = "/finance/reports/index.html"
  status = 200

[[redirects]]
  from = "/finance/*"
  to = "/finance/reports/index.html"
  status = 200

# Favicon fallback
[[redirects]]
  from = "/favicon.ico"
  to = "/favicon.svg"
  status = 200

# ============================================
# SECURITY & SEO HEADERS
# ============================================

[[headers]]
  for = "/*"
  [headers.values]
    # Security headers
    X-Frame-Options = "DENY"
    X-Content-Type-Options = "nosniff"
    X-XSS-Protection = "1; mode=block"
    Referrer-Policy = "strict-origin-when-cross-origin"
    Permissions-Policy = "geolocation=(), microphone=(), camera=(), payment=(), usb=()"
    Strict-Transport-Security = "max-age=63072000; includeSubDomains; preload"
    Cross-Origin-Opener-Policy = "same-origin"
    X-Permitted-Cross-Domain-Policies = "none"
    Cross-Origin-Resource-Policy = "same-origin"
    # Content Security Policy - strict but functional
    Content-Security-Policy = "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net https://cdn.auth0.com https://www.googletagmanager.com https://www.google-analytics.com https://uynnupaoafbwouvgcedj.supabase.co; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; img-src 'self' data: https:; connect-src 'self' https://uynnupaoafbwouvgcedj.supabase.co https://*.auth0.com https://www.google-analytics.com https://*.netlify.app https://*.netlify.com; frame-ancestors 'none'; form-action 'self' https://*.auth0.com https://uynnupaoafbwouvgcedj.supabase.co; base-uri 'self'; object-src 'none'; upgrade-insecure-requests"
    # SEO headers
    X-Robots-Tag = "index, follow, max-image-preview:large"

[[headers]]
  for = "/case-study"
  [headers.values]
    X-Robots-Tag = "index, follow, max-image-preview:large, max-snippet:-1"
    Link = "<https://safesapcrtx.org/case-study>; rel=\"canonical\""
    Cache-Control = "public, max-age=0, must-revalidate"

[[headers]]
  for = "/"
  [headers.values]
    X-Robots-Tag = "index, follow, max-image-preview:large"
    Link = "<https://safesapcrtx.org/>; rel=\"canonical\""
    Cache-Control = "public, max-age=0, must-revalidate"

[[headers]]
  for = "/sitemap.xml"
  [headers.values]
    Content-Type = "application/xml; charset=utf-8"
    Cache-Control = "public, max-age=3600"

[[headers]]
  for = "/robots.txt"
  [headers.values]
    Content-Type = "text/plain; charset=utf-8"
    Cache-Control = "public, max-age=86400"

[[headers]]
  for = "/images/*"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.js"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

[[headers]]
  for = "/*.css"
  [headers.values]
    Cache-Control = "public, max-age=31536000, immutable"

# ============================================
# PLUGINS
# ============================================

[[plugins]]
  package = "@netlify/plugin-sitemap"
  [plugins.inputs]
    buildDir = "."
    exclude = [
      # Netlify/build directories
      "./.netlify/**",
      "./netlify/**",
      "./node_modules/**",

      # WordPress honeypots
      "./wp-admin/**",
      "./wp-content/**",
      "./wp-includes/**",
      "./wp-login.php",
      "**/wp-login.php",
      "wp-login.php",
      "./wp-login/**",
      "./wordpress/**",
      "./xmlrpc/**",

      # CMS/Admin honeypots
      "./admin.html",
      "./admin/**",
      "./administrator/**",
      "./backend/**",
      "./cms/**",
      "./console/**",
      "./control/**",
      "./controlpanel/**",
      "./cpanel/**",
      "./dashboard/**",
      "./filemanager/**",
      "./godmode/**",
      "./godmode.html",
      "./install/**",
      "./login/**",
      "./manage/**",
      "./manager/**",
      "./panel/**",
      "./setup/**",
      "./shell/**",
      "./siteadmin/**",
      "./uploads/**",
      "./webadmin/**",
      "./webmail/**",

      # Database honeypots
      "./phpmyadmin/**",
      "./phpMyAdmin/**",
      "./pma/**",
      "./mysql/**",

      # Debug/dev honeypots
      "./backup/**",
      "./debug/**",
      "./dev/**",
      "./hidden-admin/**",
      "./internal-api/**",
      "./staging/**",
      "./test/**",
      "./api/**",

      # Sensitive data honeypots
      "./case-files/**",
      "./court/**",
      "./credentials/**",
      "./documents/**",
      "./donors/**",
      "./employees/**",
      "./evidence/**",
      "./finance/**",
      "./accounting/**",
      "./hr/**",
      "./legal/**",
      "./members/**",
      "./payroll/**",
      "./secrets/**",
      "./staff/**",
      "./user-data/**"
    ]
    changeFreq = "weekly"
    priority = 0.8

[[plugins]]
  package = "netlify-plugin-submit-sitemap"
  [plugins.inputs]
    baseUrl = "https://safesapcrtx.org"
    sitemapPath = "/sitemap.xml"
    providers = ["google", "bing", "yandex"]

# Webhook callback API
[[redirects]]
  from = "/api/webhook-callback"
  to = "/.netlify/functions/webhook-callback"
  status = 200
  force = true

[[redirects]]
  from = "/api/webhook-callback/*"
  to = "/.netlify/functions/webhook-callback"
  status = 200
  force = true

# Hidden admin backchannel
[[redirects]]
  from = "/hidden-admin/*"
  to = "/hidden-admin/index.html"
  status = 200
  force = true

[[redirects]]
  from = "/hidden-admin"
  to = "/hidden-admin/index.html"
  status = 200
  force = true

# Documents leaked honeypot
[[redirects]]
  from = "/documents/leaked/*"
  to = "/documents-leaked.html"
  status = 200
  force = true

[[redirects]]
  from = "/documents/leaked"
  to = "/documents-leaked.html"
  status = 200
  force = true

[[redirects]]
  from = "/leaked/*"
  to = "/documents-leaked.html"
  status = 200
  force = true

[[redirects]]
  from = "/leaked"
  to = "/documents-leaked.html"
  status = 200
  force = true

# well.known redirects
[[redirects]]
  from = "/well.known/*"
  to = "/well.known/:splat"
  status = 200

[[redirects]]
  from = "/well.known"
  to = "/well.known/index.html"
  status = 200

# NodeInfo for fediverse discovery
[[redirects]]
  from = "/.well-known/nodeinfo"
  to = "/.well-known/nodeinfo"
  status = 200
  force = true
  headers = {Content-Type = "application/json"}

[[redirects]]
  from = "/nodeinfo/2.1"
  to = "/nodeinfo/2.1.json"
  status = 200
  force = true
  headers = {Content-Type = "application/json"}

# WebFinger for ActivityPub
[[redirects]]
  from = "/.well-known/webfinger"
  to = "/.well-known/webfinger"
  status = 200
  force = true
  headers = {Content-Type = "application/jrd+json"}

# ActivityPub Actor
[[redirects]]
  from = "/actor"
  to = "/actor.json"
  status = 200
  force = true
  headers = {Content-Type = "application/activity+json"}

# Also support standard .well-known
[[redirects]]
  from = "/.well-known/*"
  to = "/well.known/:splat"
  status = 200
